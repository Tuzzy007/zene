<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Zene-kital√°l√≥</title>
<style>
:root {
  color-scheme: dark;
  --primary: #2ecc71;
  --secondary: #27ae60;
  --bg: rgba(30,30,30,0.9);
  --card-bg: rgba(40,40,40,0.85);
  --btn-bg: #2a2a2a;
  --btn-hover: #3a3a3a;
  --correct: #164e29;
  --wrong: #5a1a1a;
}

* { box-sizing: border-box; margin:0; padding:0; }

body {
  font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
  background: linear-gradient(135deg, #121212, #1a1a1a);
  color: #eaeaea;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  padding: 20px;
}

.card {
  background: var(--card-bg);
  backdrop-filter: blur(12px);
  border-radius: 20px;
  padding: 30px 25px;
  width: 100%;
  max-width: 720px;
  box-shadow: 0 12px 30px rgba(0,0,0,0.6);
  display: flex;
  flex-direction: column;
  gap: 20px;
}

h1 {
  text-align: center;
  font-size: 2rem;
  background: linear-gradient(90deg, var(--primary), var(--secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.small {
  font-size: 0.875rem;
  color: #aaa;
  text-align: center;
}

input[type="file"] {
  padding: 10px;
  border-radius: 12px;
  border: 1px solid #444;
  background: #222;
  color: #fff;
  width: 100%;
}

label, select {
  font-size: 0.95rem;
  margin-top: 5px;
}

select {
  padding: 8px 10px;
  border-radius: 12px;
  border: 1px solid #444;
  background: #222;
  color: #fff;
  width: 100%;
  margin-bottom: 10px;
}

.choices {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  justify-content: center;
  margin-top: 10px;
}

button {
  padding: 12px 18px;
  border-radius: 12px;
  border: 1px solid #333;
  background: var(--btn-bg);
  color: #fff;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  flex: 1 1 140px;
  text-align: center;
}

button:hover:not(:disabled) {
  background: var(--btn-hover);
  transform: translateY(-2px) scale(1.03);
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

button:disabled {
  opacity: 0.5;
  cursor: default;
}

.correct { background: var(--correct) !important; border-color: var(--primary) !important; }
.wrong { background: var(--wrong) !important; border-color: #e74c3c !important; }

.controls {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
  justify-content: space-between;
}

#playBtn {
  position: relative;
  overflow: hidden;
}
#playBtn .fill {
  position: absolute;
  top:0; left:0; height:100%; width:0%;
  background: linear-gradient(90deg, var(--primary), var(--secondary));
  z-index: 0;
  transition: width 0.1s linear;
}
#playBtn span { position: relative; z-index: 1; }

.status {
  font-weight: 600;
  text-align: center;
  font-size: 1rem;
  margin-top: 5px;
  min-height: 24px;
}

#miniConsole {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 300px;
  max-height: 200px;
  background: rgba(30,30,30,0.95);
  color: #0f0;
  font-family: 'Fira Mono', monospace;
  font-size: 12px;
  line-height: 1.4;
  padding: 12px;
  border-radius: 14px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.7);
  overflow-y: auto;
  border: 1px solid #0f0;
  z-index: 999;
}

#miniConsole div {
  padding: 2px 0;
  transition: color 0.3s ease;
}

#miniConsole div.info { color: #0ff; }
#miniConsole div.warn { color: #ff0; }
#miniConsole div.error { color: #f55; }
#miniConsole div.success { color: #2ecc71; }

#miniConsole::-webkit-scrollbar {
  width: 8px;
}

#miniConsole::-webkit-scrollbar-track {
  background: #111;
  border-radius: 10px;
}

#miniConsole::-webkit-scrollbar-thumb {
  background: #0f0;
  border-radius: 10px;
}

#miniConsole::-webkit-scrollbar-thumb:hover {
  background: #2ecc71;
}

#round { text-align:center; font-weight:500; margin-bottom:8px; font-size:1rem; }

</style>
</head>
<body>
<div class="card">
  <h1>Zene-kital√°l√≥ üéµ</h1>
  <p class="small">V√°laszd ki a <strong>music</strong> mapp√°t (mp3/m4a f√°jlokkal), majd kattints a <strong>K√∂vetkez≈ë</strong> gombra!</p>

  <input type="file" id="folderInput" webkitdirectory directory multiple />

  <label for="difficulty" id="difficultyLabel">Neh√©zs√©g:</label>
  <select id="difficulty">
    <option value="10" data-min="2" data-max="3">K√∂nny≈± (10mp/2-3 opci√≥)</option>
    <option value="7" data-min="3" data-max="4">K√∂zepes (7mp/3-4 opci√≥)</option>
    <option value="2" data-min="4" data-max="6">Neh√©z (2mp/4-6 opci√≥)</option>
  </select>


  <div id="round">T√∂lts be egy mapp√°t a kezd√©shez.</div>
  <div class="choices" id="choices"></div>

  <div class="controls">
    <button id="playBtn"><div class="fill"></div><span>Lej√°tsz√°s</span></button>
    <button id="stopBtn">Le√°ll√≠t</button>
    <button id="nextBtn">K√∂vetkez≈ë</button>
    <button id="replayBtn">√öjra hallgat√°s (-2 pont)</button> <br>
    <div style="margin-left:auto">
      Pontok: <span id="score">0</span>
      Zene: <span id="roundNum">0</span>.
    </div>
  </div>


  <div class="status" id="status"></div>
</div>
<div id="miniConsole"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  let songs=[],remainingSongs=[],current=null,score=parseInt(getCookie('score')||0),rounds=0,playStart=0,PLAY_DURATION=10;
  const playBtn=document.getElementById('playBtn');
  const stopBtn=document.getElementById('stopBtn');
  const nextBtn=document.getElementById('nextBtn');
  const replayBtn=document.getElementById('replayBtn');
  const status=document.getElementById('status');
  const choicesDiv=document.getElementById('choices');
  const roundDiv=document.getElementById('round');
  const scoreSpan=document.getElementById('score');
  const roundNumSpan=document.getElementById('roundNum');
  const folderInput=document.getElementById('folderInput');
  const difficulty=document.getElementById('difficulty');
  const miniConsole=document.getElementById('miniConsole');
  const audio=new Audio();
  scoreSpan.textContent=score;
  let hasPlayed = false;
  let playedOnce = false;
  let isPaused = false;
  let warnedNotLoaded = false;

  function logMiniConsole(msg, type='info'){
    const line = document.createElement('div');
    line.textContent = msg;
    line.className = type;
    miniConsole.appendChild(line);
    miniConsole.scrollTop = miniConsole.scrollHeight;
  }

  function formatTime(t){const m=Math.floor(t/60);const s=Math.floor(t%60);return `${m}:${s.toString().padStart(2,'0')}`;}
  function setCookie(n,v,d=365){let x=new Date();x.setTime(x.getTime()+(d*24*60*60*1000));document.cookie=n+"="+v+";expires="+x.toUTCString()+";path=/";}
  function getCookie(n){let v=document.cookie.match('(^|;) ?'+n+'=([^;]*)(;|$)'); return v?v[2]:null;}

  folderInput.addEventListener('change', e=>{
    const files=Array.from(e.target.files).filter(f=>f.name.endsWith('.mp3')||f.name.endsWith('.m4a'));
    if(!files.length){roundDiv.textContent='Nem tal√°ltam megfelel≈ë hangf√°jlt!'; return;}
    songs=files.map(f=>({file:URL.createObjectURL(f),title:f.name.replace(/\.[^/.]+$/,'')}));
    remainingSongs=[...songs]; rounds=0; roundNumSpan.textContent=0; choicesDiv.innerHTML=''; miniConsole.innerHTML=''; roundDiv.textContent=`${songs.length} zene bet√∂ltve!`;
  });

  function shuffleArray(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}}

  function getOptionCount(){const opt=difficulty.options[difficulty.selectedIndex]; const min=parseInt(opt.dataset.min), max=parseInt(opt.dataset.max); return Math.floor(Math.random()*(max-min+1))+min;}

  function nextRound(){
    audio.pause(); audio.currentTime=0; const fill=playBtn.querySelector('.fill'); if(fill) fill.style.width='0%';
    if(remainingSongs.length<3){roundDiv.textContent='Legal√°bb 3 k√ºl√∂nb√∂z≈ë zene kell a j√°t√©khoz!'; return;}
    status.textContent=''; choicesDiv.innerHTML='';

    const randomIndex=Math.floor(Math.random()*remainingSongs.length);
    const song=remainingSongs.splice(randomIndex,1)[0];
    current=songs.findIndex(s=>s.title===song.title); rounds++; roundNumSpan.textContent=rounds;

    // Neh√©zs√©g alapj√°n opci√≥k sz√°ma
    const optionCount=getOptionCount();
    const available=songs.filter(s=>s.title!==song.title); shuffleArray(available);
    const options=[song,...available.slice(0,optionCount-1)]; shuffleArray(options);

    options.forEach(opt=>{
      const btn=document.createElement('button'); btn.textContent=opt.title;
      btn.onclick=()=>{
        Array.from(choicesDiv.children).forEach(b=>b.disabled=true);
        let pts=parseInt(difficulty.value)==10?1:parseInt(difficulty.value)==7?3:5;
        if(opt.title===song.title){score+=pts; status.textContent='‚úÖ Helyes!'; btn.classList.add('correct'); replayBtn.disabled = true;}
        else{status.textContent='‚ùå Rossz. A helyes v√°lasz: '+song.title; btn.classList.add('wrong');
          Array.from(choicesDiv.children).forEach(b=>{if(b.textContent===song.title)b.classList.add('correct');}); replayBtn.disabled = true;}
        scoreSpan.textContent=score; setCookie('score',score);
      };
      choicesDiv.appendChild(btn);
    });

    roundDiv.innerHTML='<strong>V√°laszd ki a helyes c√≠met:</strong>';
    audio.src=song.file; audio.load();
    audio.onloadedmetadata = () => {
      const duration = audio.duration;
      if (!isFinite(duration) || duration <= 0) {
        playStart = 0;
        logMiniConsole('‚ö†Ô∏è A zene m√©g nem t√∂lt≈ëd√∂tt be teljesen', 'warn');
        return;
      }
    
      const half = duration / 2;
      const maxStart = Math.max(0, half - parseInt(difficulty.value));
      playStart = Math.random() * maxStart;
      PLAY_DURATION = parseInt(difficulty.value);
      logMiniConsole('üéß Random r√©szlet: ' + formatTime(playStart) + '‚Äì' + formatTime(playStart + PLAY_DURATION), 'success');
    };
  }

  function safePlay(start, duration) {
    const fill = playBtn.querySelector('.fill'); 
    if (!fill) return;

    if (isPaused) {
      audio.play().then(() => logMiniConsole('‚ñ∂Ô∏è Folytat√°s', 'info')).catch(()=>logMiniConsole('‚ö†Ô∏è A zene nem indult el', 'warn'));
      isPaused = false;
      requestAnimationFrame(updateProgress);
      return;
    }

    if (playedOnce) return;

    audio.currentTime = start;
    const endTime = start + duration;
    let hasHeardHalfSec = false;

    function tryPlay() {
      audio.play().then(() => {
        logMiniConsole(`üéµ Lej√°tsz√°s: ${formatTime(start)}‚Äì${formatTime(endTime)}`, 'info');
      }).catch(() => {
        logMiniConsole('‚ö†Ô∏è A zene m√©g nem indult el, pr√≥b√°lkozunk √∫jra...', 'warn');
        setTimeout(tryPlay, 200);
      });
    }
    tryPlay();

    const stopHandler = () => {
      if (!hasHeardHalfSec && audio.currentTime - start >= 1) {
        hasHeardHalfSec = true;
        playedOnce = true;
        logMiniConsole('‚úÖ Zen√©b≈ël hallgatt√°l m√°r 1 mp-et, a play gomb innent≈ël nem ind√≠that√≥ √∫jra.', 'success');
      }
      if (!hasHeardHalfSec && audio.currentTime - start < 0.5 && audio.paused && !warnedNotLoaded) {
        logMiniConsole('‚ö†Ô∏è A zene m√©g nem t√∂lt≈ëd√∂tt be.', 'warn');
      }
      if (audio.currentTime >= endTime) {
        audio.pause();
        audio.removeEventListener('timeupdate', stopHandler);
      }
    };
    audio.addEventListener('timeupdate', stopHandler);

    function updateProgress() {
      if (audio.paused) return;
      const p = ((audio.currentTime - start)/duration)*100;
      fill.style.width = Math.min(Math.max(p,0),100)+'%';
      requestAnimationFrame(updateProgress);
    }
    requestAnimationFrame(updateProgress);
  }


  // Gombok kezel√©se
  playBtn.onclick = () => safePlay(playStart, PLAY_DURATION);

  stopBtn.onclick = () => {
    if (!audio.paused) {
      audio.pause();
      isPaused = true;
      logMiniConsole('‚è∏Ô∏è Lej√°tsz√°s sz√ºneteltetve', 'info');
    }
  };

  nextBtn.onclick = () => {
    difficulty.style.display = 'none';
    document.getElementById('difficultyLabel').style.display = 'none';
    playedOnce = false; 
    isPaused = false;
    nextRound();
    replayBtn.disabled = false;
  };



  replayBtn.onclick = () => {
    if(score < 2) {
      logMiniConsole('‚ö†Ô∏è Nincs el√©g pont az √∫jraj√°tsz√°shoz!', 'warn');
      return;
    }
    score -= 2;
    scoreSpan.textContent = score;
    setCookie('score', score);
    logMiniConsole('‚ôªÔ∏è √öjraj√°tsz√°s: -2 pont', 'info');
    isPaused = false;
    playedOnce = false;
    safePlay(playStart, PLAY_DURATION);
  };

});
</script>
</body>
</html>
